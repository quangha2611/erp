$(function(){$('#beginDateTime, #endDateTime').each(function(){var option={format:'DD/MM/YYYY hh:ss A',startDate:moment(),endDate:moment(),showDropdowns:true,timePicker:true,timePickerIncrement:15,opens:'left',singleDatePicker:true};$(this).daterangepicker(option)});$('#tag-input').autocomplete({source:function(request,response){$.post('/system/user/suggest',{'q':request.term,},function(rs){if(rs.code){response(rs.data);}else{response([]);}});},minLength:2,select:function(event,ui){event.preventDefault();addUser(ui.item)},close:function(){$('#tag-input').val('');}});$('#calendar_user_input').on('click','span[data-role="remove"]',function(){$(this).parent().remove();var userIds=[];$('#calendar_user_input span.tag').each(function(){userIds.push($(this).attr('idref'));});$('#calendar_userIds').val(userIds.join(','));});$('#targetName').autocomplete({source:function(request,response){$.post('/crm/lead/suggestall',{'q':request.term,},function(rs){if(rs.data.length){response(rs.data);}else{$('#targetName').parent().removeClass('has-success').addClass('has-error');$('.targetName-check').removeClass('fa fa-check').addClass('fa fa-times');$('#groupTargetInfor .groupContent').hide()
response([]);}});},minLength:2,select:function(event,ui){setTarget(ui.item);$('#targetName').parent().addClass('has-success').removeClass('has-error');$('.targetName-check').removeClass('fa fa-times').addClass('fa fa-check');}});$('#targetName').on('change',function(){if(!$(this).val()){$('#accountId, #contactId, #opportunityId, #leadId').val('');$('#groupTargetInfor .groupContent').hide();}});$('#lead_mobile, #lead_mobile2, #lead_phone, #lead_phone2').on('change',function(){var item=$(this);item.parent().find('ul.parsley-error-list').remove();item.parent().removeClass('has-error has-success');item.parent().find('.form-control-feedback').removeClass('fa-times fa-check')
if($(this).val()){$.post('/crm/lead/checkinfor',{'q':item.val(),'companyId':$('#companyId').val(),'type':'mobile'},function(rs){if(rs.code){item.parent().find('ul.parsley-error-list').remove();item.parent().addClass('has-success').removeClass('has-error');item.parent().find('.form-control-feedback').addClass('fa fa-check').removeClass('fa-times')}else{var ul=$('<ul/>').addClass('parsley-error-list');ul.append($('<li/>').text(rs.messages));item.parent().append(ul);item.parent().removeClass('has-success').addClass('has-error');item.parent().find('.form-control-feedback').addClass('fa fa-times').removeClass('fa-check')}});}});$('#lead_email').on('change',function(){var item=$(this);item.parent().find('ul.parsley-error-list').remove();item.parent().removeClass('has-error has-success');item.parent().find('.form-control-feedback').removeClass('fa-times fa-check')
if($(this).val()){$.post('/crm/lead/checkinfor',{'q':item.val(),'companyId':$('#companyId').val(),'type':'email'},function(rs){if(rs.code){item.parent().find('ul.parsley-error-list').remove();item.parent().addClass('has-success').removeClass('has-error');item.parent().find('.form-control-feedback').addClass('fa fa-check').removeClass('fa-times')}else{var ul=$('<ul/>').addClass('parsley-error-list');ul.append($('<li/>').text(rs.messages));item.parent().append(ul);item.parent().removeClass('has-success').addClass('has-error');item.parent().find('.form-control-feedback').addClass('fa fa-times').removeClass('fa-check')}});}});$('#lead_website').on('change',function(){var item=$(this);item.parent().find('ul.parsley-error-list').remove();item.parent().removeClass('has-error has-success');item.parent().find('.form-control-feedback').removeClass('fa-times fa-check')
if($(this).val()){$.post('/crm/lead/checkinfor',{'q':item.val(),'companyId':$('#companyId').val(),'type':'website'},function(rs){if(rs.code){item.parent().find('ul.parsley-error-list').remove();item.parent().addClass('has-success').removeClass('has-error');item.parent().find('.form-control-feedback').addClass('fa fa-check').removeClass('fa-times')}else{var ul=$('<ul/>').addClass('parsley-error-list');ul.append($('<li/>').text(rs.messages));item.parent().append(ul);item.parent().removeClass('has-success').addClass('has-error');item.parent().find('.form-control-feedback').addClass('fa fa-times').removeClass('fa-check')}});}});$('.addNewCustomer').on('click',function(){$('#accountId, #contactId, #opportunityId, #leadId').val('');$('#groupTargetInfor .groupContent').hide();$('#groupTargetInfor').hide();$('#groupNewCustomer').show();$('#isNewCustomer').val(1);});$('.backsystemCustomer').on('click',function(){$('#groupNewCustomer').hide();$('#isNewCustomer').val('');$('#groupTargetInfor').show();})});function addUser(item){if(!$('#calendar_user_input').find('span[idref="'+item.id+'"]').length){var tag=$('<span/>').addClass('tag label label-info').attr('idref',item.id).text(item.username).append($('<span>').attr('data-role','remove'));$('#tag-input').before(tag);var userIds=[];$('#calendar_user_input span.tag').each(function(){userIds.push($(this).attr('idref'));});$('#calendar_userIds').val(userIds.join(','));}
$('#tag-input').autocomplete('close');$('#tag-input').val('');}
function setTarget(item){switch(item.type){case'lead':$('#leadId').val(item.id);$('#target-type').text('Thông tin');break;case'opportunity':$('#opportunityId').val(item.id);$('#target-type').text('Cơ hội');break;case'account':$('#accountId').val(item.id);$('#target-type').text('Khách hàng');break;case'contact':$('#contactId').val(item.id);$('#target-type').text('Liên hệ');break;default:return false;}
$('#target-id').text(item.id);$('#target-name').text(item.name);$('#target-website').text(item.website);$('#target-email').text(item.email);var mobile=[];var phone=[];if(item.mobile){mobile.push(item.mobile);}
if(item.mobile2){mobile.push(item.mobile2);}
if(item.phone){phone.push(item.phone);}
if(item.phone2){phone.push(item.phone2)}
$('#target-mobile').text(mobile.join(' - '));$('#target-phone').text(phone.join(' - '));$('#groupTargetInfor .groupContent').show();}