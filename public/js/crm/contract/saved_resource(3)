$(function(){var isnumeric=$('.isAutonumeric');isnumeric.autoNumeric("init",{'mDec':0});Department.load('#companyId','#departmentId');$('.exportExcel').jsExcelExport({'param':{'format':'excel'}});$('#exportAll').jsExcelExport({'param':{'format':'csv'}});$('#exportProductAll').jsExcelExport({'param':{'format':'productExcelAll'}});$('#productId').multiselect({enableCaseInsensitiveFiltering:true,nonSelectedText:'Sản phẩm'});$("#companyId").select2({dropdownAutoWidth:true,});$("#departmentId").select2({dropdownAutoWidth:true});$('.deteleContract').click(function(){var id=$(this).attr('data-id');var html="<div class='alert alert-info alert-dismissable'>Bạn có muốn xóa hợp đồng này?</div>";$("#myModal").modal('show');$('#myModal .modal-body').empty();$('#myModal .modal-body').append(html);$('#myModal .modal-footer').append("<div class='deleteId' value='"+id+"'></div>");});$('#myModal .modal-footer').on('click','.accept',deleteConfirm);function deleteConfirm(){var id=$('.deleteId').attr('value');$.post("/crm/contract/delete",{id:id},function(rs){var html='<div class="alert alert-success alert-dismissable">'+rs.messages+'</div>';if(rs.code>0){$("#myModal").modal('hide');$("#alertModal").modal('show');$('#alertModal .modal-body').empty();$('#alertModal .modal-body').append(html);}else{var html='<div class="alert alert-warning alert-dismissable"> '+rs.messages+'</div>';$("#myModal").modal('hide');$("#alertModal").modal('show');$('#alertModal .modal-body').empty();$('#alertModal .modal-body').append(html);}});}
$('#customerName').catcomplete({source:function(request,response){$.post('/crm/customer/suggest',{'q':request.term,'page':'customer.catcomplete.allingroup'},function(rs){if(rs.code){response(rs.data);}});},minLength:2,select:function(event,ui){if(ui.item.crmType=='lead'){$('#leadId').val(ui.item.id);$('#accountId').val(ui.item.accountId);}
if(ui.item.crmType=='account'){$('#accountId').val(ui.item.id);$('#leadId').val('');}},});$('#commissionName').autocomplete({source:function(request,response){$.post('/hrm/employee/suggest',{'q':request.term,'page':'crm.contract.add'},function(rs){if(rs.code){response(rs.data);}});},minLength:2,select:function(event,ui){$('#commissionEmployeeId').val(ui.item.id);},});$('#createdByName').autocomplete({source:function(request,response){$.post('/system/user/suggest',{'q':request.term},function(rs){if(rs.code){response(rs.data);}});},minLength:2,select:function(event,ui){$('#createdById').val(ui.item.id);},});$('#createdByName').on('change',function(){if(!$('#createdByName').val()){$('#createdById').val('');}});$('#approvedByName').autocomplete({source:function(request,response){$.post('/system/user/suggest',{'q':request.term},function(rs){if(rs.code){response(rs.data);}});},minLength:2,select:function(event,ui){$('#approvedById').val(ui.item.id);},});$('#approvedByName').on('change',function(){if(!$('#approvedByName').val()){$('#approvedById').val('');}});$('#stampedByName').autocomplete({source:function(request,response){$.post('/system/user/suggest',{'q':request.term},function(rs){if(rs.code){response(rs.data);}});},minLength:2,select:function(event,ui){$('#stampedById').val(ui.item.id);},});$('#stampedByName').on('change',function(){if(!$('#stampedByName').val()){$('#stampedById').val('');}});$('#dgContract').on('click','.reapprove',function(){var id=$(this).data('id');$('#confirmReapproveModal .referId').val(id);$('#confirmReapproveModal .alert').html('Bạn muốn hoàn duyệt hợp đồng '+id);$('#confirmReapproveModal').modal('show');});$('#confirmReapproveModal .btnSave').click(function(){var id=$('#confirmReapproveModal .referId').val();$('#confirmReapproveModal').modal('hide');$('#loadingModal').modal('show');$.post('/crm/contract/reapprove',{'id':id},function(rs){$('#loadingModal').modal('hide');if(rs.code){var tr=$('#dgContract .reapprove[data-id="'+id+'"]').closest('tr');tr.find('.colStatus').html('<a class="text-success" data-toggle="tooltip" title="Bấm để duyệt" href="/crm/contract/approve?id='+id+'"><b>Chưa duyệt</b></a>');tr.find('.reapprove').remove();}else{$('#errorModal .alert').html(rs.messages.join('<br/>'));$('#errorModal').modal('show');}});});$('#nav-table ul li a').on('click',function(){var hasThis=$(this).hasClass('active');var AttClas=$(this).attr('data-name');if(hasThis){$(this).removeClass('active');$(this).children('i').removeClass('fa-check-square');$(this).children('i').addClass('fa-square-o');$('.'+AttClas).fadeOut(10);}else{$('.'+AttClas).fadeIn(100);$(this).addClass('active');$(this).children('i').removeClass('fa-square-o');$(this).children('i').addClass('fa-check-square');}});$('#nav-table button').on('click',function(){$('#nav-table .dropdown-menu').toggle(200);$('#nav-table .mask-body').toggle();});$('#nav-table .mask-body').on('click',function(){$('#nav-table .dropdown-menu').fadeOut(10);$('#nav-table .mask-body').fadeOut(10);});$('.showRequirement').on('click',function(){$('#requirementId').empty().val($(this).attr('data-requirementId'));$.post('/crm/requirement/load',{'requirementId':$(this).attr('data-requirementId'),},function(rs){$('#show-requirement-area').html(rs);});$('#acceptRequirementModal').modal('show');})
$('#acceptRequirementModal').on('click','.accept-btn',function(){$.post('/crm/requirement/acceptvg',{'requirementId':$('#requirementId').val(),'startedDate':$('.startedDate').val(),'endedDate':$('.endedDate').val(),'confirmValue':$('.confirmValue').val(),'otherValue':$('.otherValue').val(),'extraValue':$('.extraValue').val(),'valueType':$('input[name=valueType]:checked').val(),'type':1},function(rs){if(rs.code){html='<div class="alert alert-success alert-dismissable">'+rs.messages+'</div>';$("#acceptRequirementModal").modal('hide');$("#alertModal").modal('show');$('#alertModal .modal-body').empty();$('#alertModal .modal-body').append(html);loadService($('.customer-leadId').val(),$('.customer-accounId').val());}else{html='<div class="alert alert-warning alert-dismissable">'+rs.messages+'</div>';$("#acceptRequirementModal").modal('hide');$("#alertModal").modal('show');$('#alertModal .modal-body').empty();$('#alertModal .modal-body').append(html);}});});$('.reload').on('click',function(){window.location.reload();});$('#dgContract').on('click','.updateStampedEmployee',function(){var id=$(this).data('id');$('#updateStampedEmployeeModal .contractId').val(id);$('#updateStampedEmployeeModal').modal('show');});$('.stampedContractName').autocomplete({source:function(request,response){$.post('/system/user/suggest',{'q':request.term,},function(rs){if(rs.code){response(rs.data);}else{response([]);}});},minLength:2,select:function(event,ui){$('.stampedContractId').val(ui.item.id);},});$('.save-accept-contract-support-btn').on('click',function(){var contractId=$('#updateStampedEmployeeModal .contractId').val();stampedById=$('.stampedContractId').val();supportedDate=$('.suportedDate ').val();$.post('/crm/contract/updatesuport',{'contractId':contractId,'stampedById':stampedById,'supportedDate':supportedDate},function(rs){if(rs.code){html='<div class="alert alert-success alert-dismissable">'+rs.messages+'</div>';$("#updateStampedEmployeeModal").modal('hide');$("#alertModal").modal('show');$('#alertModal .modal-body').empty();$('#alertModal .modal-body').append(html);}else{html='<div class="alert alert-warning alert-dismissable">'+rs.messages+'</div>';$("#updateStampedEmployeeModal").modal('hide');$("#alertModal").modal('show');$('#alertModal .modal-body').empty();$('#alertModal .modal-body').append(html);}});});$('.updateOriginalStatus').on('click',function(){var contractId=$(this).attr('data-id');$('#updateOriginalStatusModal .confirmUpdateOriginalStatus').attr('data-id',contractId);$('#updateOriginalStatusModal').modal('show');});$('#updateOriginalStatusModal .originalStatus').on('change',function(){var originalStatus=$(this).val();$('#updateOriginalStatusModal .originalStatus').each(function(){if($(this).val()!=originalStatus){this.checked=false;}})});$('#updateOriginalStatusModal .confirmUpdateOriginalStatus').on('click',function(){var contractId=$(this).attr('data-id');var originalStatus=0;$('#updateOriginalStatusModal .originalStatus').each(function(){if(this.checked){originalStatus=$(this).val();}});if(!contractId||!originalStatus){var html='<div class="alert alert-warning alert-dismissable">Bạn vui lòng chọn trạng thái hợp đồng gốc</div>';$('#updateOriginalStatusModal').modal('hide');$("#alertModal").modal('show');$('#alertModal .modal-body').empty();$('#alertModal .modal-body').append(html);return false;}
$.post('/crm/contract/updatepaperstatus',{'id':contractId,'originalStatus':originalStatus,},function(rs){if(rs.code){window.location.reload();}else{html='<div class="alert alert-warning alert-dismissable">'+rs.messages+'</div>';$('#updateOriginalStatusModal').modal('hide');$("#alertModal").modal('show');$('#alertModal .modal-body').empty();$('#alertModal .modal-body').append(html);}});})});