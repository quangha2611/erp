$(function(){$('#userIdSuggest').catcomplete({source:function(request,response){$.post('/hrm/employee/suggest',{'q':request.term,'page':'category.company'},function(rs){if(rs.code){response(rs.data);}});},minLength:2,select:function(event,ui){$('#userId').val(ui.item.userId);},});$('#dgCustomer').on('click','.pickup',function(){var name=$('#dgCustomer').find('.'+$(this).data('namerefer')).text();$('#confirmPickupModal .referId').val($(this).data('leadid'));$('#confirmPickupModal .customerName').text(name);$('#confirmPickupModal').modal('show');});$('#confirmPickupModal .btn-save').on('click',function(){$.post('/crm/lead/setleaduser',{'crm_type':'lead','id':$('#confirmPickupModal .referId').val(),'mode':'selfAssign','saleIds':1},function(rs){$('#confirmPickupModal').modal('hide');if(typeof rs.code=='undefined'){$('#errorModal .alert').html(pageVariable.messages.SERVER_ERROR);$('#errorModal').modal('show');}else{if(rs.code){$('#successModal .alert').html(pageVariable.messages.PICKUP_SUCCESS);$('#successModal').modal('show');}else{$('#errorModal .alert').html(rs.messages.join('<br/>'));;$('#errorModal').modal('show');}}}).fail(function(response){$('#confirmPickupModal').modal('hide');if(response.status=='403'){$('#errorModal .alert').html(pageVariable.messages.PAGE_DENIED);$('#errorModal').modal('show');}})});$('#confirmAssignModal .userName').catcomplete({appendTo:'#confirmAssignModal .modal-body',source:function(request,response){$.post('/hrm/employee/suggest',{'q':request.term,'page':'category.company'},function(rs){if(rs.code){response(rs.data);}});},minLength:2,select:function(event,ui){event.preventDefault();$('#confirmAssignModal .userName').val('');createUserTag(ui.item);},});$('#confirmAssignModal').on('click','.remove-tag',function(){$(this).closest('span.tag').remove();});$('#dgCustomer').on('click','.assign',function(){var name=$('#dgCustomer').find('.'+$(this).data('namerefer')).text();$('#confirmAssignModal .referId').val($(this).data('leadid'));$('#confirmAssignModal .customerName').text(name);$('#confirmAssignModal').modal('show');});$('#confirmAssignModal .btn-save').on('click',function(){var userIds=[];$('#confirmAssignModal span.tag').each(function(){userIds.push($(this).data('id'));});if(userIds.length){$.post('/crm/lead/addmultiuser',{'crm_type':'lead','ids':$('#confirmAssignModal .referId').val(),'userIds':{'1':userIds},},function(rs){$('#confirmAssignModal').modal('hide');if(typeof rs.code=='undefined'){$('#errorModal .alert').html(pageVariable.messages.SERVER_ERROR);$('#errorModal').modal('show');}else{if(rs.code){$('#successModal .alert').html(pageVariable.messages.ASSIGN_SUCCESS);$('#successModal').modal('show');}else{$('#errorModal .alert').html(rs.messages.join('<br/>'));;$('#errorModal').modal('show');}}}).fail(function(response){$('#confirmAssignModal').modal('hide');if(response.status=='403'){$('#errorModal .alert').html(pageVariable.messages.PAGE_DENIED);$('#errorModal').modal('show');}})}else{$('#errorModal .alert').html(pageVariable.messages.NO_USER_SELECT);$('#errorModal').modal('show');}});$('#dgCustomer').on('click','.discard',function(){$('#confirmDiscardModal .userId').val($(this).data('userid'));$('#confirmDiscardModal .leadId').val($(this).data('leadid'));var userName=$(this).parent().find('.employeeName').text();var customerName=$('#dgCustomer').find('.'+$(this).data('namerefer')).text();$('#confirmDiscardModal .customerName').text(customerName);$('#confirmDiscardModal .employeeName').text(userName);$('#confirmDiscardModal').modal('show');$('#confirmDiscardModal').data('itemrefer',$(this).parent());});$('#confirmDiscardModal .btn-save').on('click',function(){var leadId=$('#confirmDiscardModal .leadId').val();var userId=$('#confirmDiscardModal .userId').val();var item=$('#confirmDiscardModal').data('itemrefer');$.post('/crm/lead/discard',{'id':leadId,'userId':userId},function(rs){$('#confirmDiscardModal').modal('hide');if(typeof rs.code=='undefined'){$('#errorModal .alert').html(pageVariable.messages.SERVER_ERROR);$('#errorModal').modal('show');}else{if(rs.code){$('#successModal .alert').html(pageVariable.messages.DISCARD_SUCCESS);$('#successModal').modal('show');item.remove();}else{$('#errorModal .alert').html(rs.messages.join('<br/>'));;$('#errorModal').modal('show');}}}).fail(function(response){$('#confirmDiscardModal').modal('hide');if(response.status=='403'){$('#errorModal .alert').html(pageVariable.messages.PAGE_DENIED);$('#errorModal').modal('show');}})});});function createUserTag(item){var tag=$('<span/>').addClass('tag label label-primary label-sm').attr('data-id',item.userId).css('display','inline-block');tag.append(item.label);tag.append('&nbsp;<a href="#" class="remove-tag fa fa-times text-danger">');$('#confirmAssignModal .user-area').append(tag);}