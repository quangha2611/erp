$(document).ready(function(){var statusname='';$('.update').click(update);$('#assignModal').on('hide.bs.modal',function(e){$('#dgCrmLead .editing').removeClass('editing');});$('#selfAssignModal').on('hide.bs.modal',function(e){$('#dgCrmLead .editing').removeClass('editing');$('#selfAssignModal .save').attr('data-leadid','');});$('#confirmModal').on('hide.bs.modal',function(e){$('#dgCrmLead .editing').removeClass('editing');$('#confirmModal .save').attr('data-leadid','');});$('#assignModal .bootstrap-tagsinput').on('click',function(){$(this).find('input[type="text"]').focus()});$('#assignModal span').on('click',function(e){e.stopPropagation();});$('#assignModal').on('click','.removeTag',function(e){$(this).closest('.tag').remove();});$('#assignModal .userAssignSuggest').autocomplete({appendTo:'#assignModal .modal-body',source:function(request,response){$.post('/system/user/suggest',{'q':request.term},function(rs){if(rs.code){response(rs.data);}});},minLength:2,select:function(event,ui){event.stopPropagation();event.preventDefault();$(this).val('');appendNameSuggest(ui.item,$(this).parent())},});$('.assignLead').on('click',function(){$('#assignModal .loading').show();$('#assignModal .saveMultiple').hide();$('#assignModal .save').show();$('#assignModal .formAssignt').hide();$('#assignModal').modal('show');$('#assignModal .formAssignt .bootstrap-tagsinput span').remove();var id=$(this).attr('data-leadid');$('#assignModal .save').attr('data-leadid','');$('#assignModal .save').button('loading');$.post('/crm/lead/manageleaduser',{'id':id,'crm_type':'account'},function(rs){if(rs.code){if(rs.data.hasOwnProperty('sale')){for(var i in rs.data.sale){appendNameSuggest(rs.data.sale[i],$('#saleAssign'));}}
if(rs.data.hasOwnProperty('telesale')){for(var i in rs.data.telesale){appendNameSuggest(rs.data.telesale[i],$('#telesaleAssign'));}}
if(rs.data.hasOwnProperty('support')){for(var i in rs.data.support){appendNameSuggest(rs.data.support[i],$('#supportAssign'));}}
$('#assignModal .loading').hide();$('#assignModal .formAssignt').show();$('#assignModal .save').attr('data-leadid',id);$('#assignModal .save').button('reset');}else{$('#assignModal').modal('hide');$('#errorModal .alert').html(rs.messages.join('<br/>'));$('#errorModal').modal('show');$('#assignModal .save').attr('data-leadid','');$('#dgCrmLead .editing').removeClass('editing');}});});$('#assignModal .save').on('click',function(){if($(this).attr('data-leadid')){var id=$(this).attr('data-leadid');var saleIds=[];var telesaleIds=[];var supportIds=[];$('#saleAssign .tag').each(function(){saleIds.push($(this).attr('data-userid'));});$('#telesaleAssign .tag').each(function(){telesaleIds.push($(this).attr('data-userid'));});$('#supportAssign .tag').each(function(){supportIds.push($(this).attr('data-userid'));});$.post('/crm/lead/setleaduser',{'id':id,'crm_type':'account','mode':'all','saleIds':saleIds.join(','),'telesaleIds':telesaleIds.join(','),'supportIds':supportIds.join(',')},function(rs){if(rs.code){$('#assignModal').modal('hide');html='<div class="alert alert-success alert-dismissable">Bàn giao thành công!</div>';$("#closeModel").modal('show');$('#closeModel .modal-body').empty();$('#closeModel .modal-body').append(html);}else{$('#assignModal').modal('hide');$('#errorModal .alert').html(rs.messages.join('<br/>'));$('#errorModal').modal('show');$('#assignModal .save').attr('data-leadid','');$('#dgCrmLead .editing').removeClass('editing');}});}});function update()
{var status=$(this).attr('value');var statusName=$(this).text();statusname=statusName;$('#myModal').modal('show');$('#myModal .modal-body').empty();$('#myModal .modal-body').append('<div id="status" value="'+status+'" class="alert alert-info alert-dismissable">Thay đổi trạng thái : <span style="color:red;"> '+statusName+'<span></div>');}
$('#myModal .modal-footer').on('click','.saveStatus',updateStatus);function updateStatus(){var accountId=$('#accountId').val();var status=$('#status').attr('value');var statusName=$('.update').text();$.post("/crm/account/updatestatus",{accountId:accountId,status:status},function(rs){if(rs.code>0){$('span.checkCircle').empty();$('span.checkCircle').append("("+statusname+")");$('#closeModel').modal('show');$('#myModal').modal('hide');$('#closeModel .modal-body').empty();$('#closeModel .modal-body').append("<div class='alert alert-success alert-dismissable'> "+rs.messages+"</div>");}else{$('#closeModel').modal('show');$('#myModal').modal('hide');$('#closeModel .modal-body').empty();$('#closeModel .modal-body').append("<div class='alert alert-warning'>"+rs.messages+" </div>");}})}
$('.modal-footer').on('click','.reload',function(){window.location.reload();});$('#share-link').on('click',function(){$('#sharelinkModal').modal('show');$('#showlink-txt').focus();});$('#copy-btn').on('click',function(){$('#showlink-txt').focus();$('#showlink-txt').select();})
$('#editContact').on('click',function(){$('#updateContactModal').modal('show');});$('#updateContactModal').on('click','.save-contact',function(){var accountId=$('#accountId').val();$.post('/crm/account/updatecontact',{'accountId':accountId,'name':$('#name-contact-txt').val(),'department':$('#department-contact-txt').val(),'gender':$('#genderContact').val(),'mobile':$('#mobile-contact-txt').val(),'email':$('#email-contact-txt').val(),'address':$('#address-contact-txt').val(),'description':$('#description-contact-txt').val(),},function(rs){if(rs.code){html='<div class="alert alert-success alert-dismissable">'+rs.messages+'</div>';$("#updateContactModal").modal('hide');$("#alertModal").modal('show');$('#alertModal .modal-body').empty();$('#alertModal .modal-body').append(html);}else{html='<div class="alert alert-warning alert-dismissable">'+rs.messages+'</div>';$("#updateContactModal").modal('hide');$("#alertModal").modal('show');$('#alertModal .modal-body').empty();$('#alertModal .modal-body').append(html);}});});$('.delContact').on('click',function(){var item=$(this);$.post('/crm/contact/delete',{id:$(this).attr('data-id')},function(rs){if(rs.code){item.closest('tr').remove();}else{html='<div class="alert alert-warning alert-dismissable">'+rs.messages+'</div>';$("#alertModal").modal('show');$('#alertModal .modal-body').empty();$('#alertModal .modal-body').append(html);}});})
$('.updateOpportunityStatus').on('click',function(){var leadId=$(this).attr('data-id');$('#updateOpportunityModal .save-update-opportunity').attr('data-leadId',leadId);$('#updateOpportunityModal').modal('show');});$('#updateOpportunityModal .save-update-opportunity').on('click',function(){var leadId=$(this).attr('data-leadId');var elementToAppend=$('.opportunityStatus'+leadId);var salesStage=$("input[name='levelSaleStage']:checked").val();if(!salesStage){$("#updateOpportunityModal").modal('hide');html='<div class="alert alert-warning alert-dismissable">Bạn chưa chọn Level khách hàng</div>';$("#alertModal").modal('show');$('#alertModal .modal-body').empty();$('#alertModal .modal-body').append(html);return false;}
$.post('/crm/lead/updateopportunity',{'leadId':leadId,'salesStage':salesStage,},function(rs){if(rs.code){$("#updateOpportunityModal").modal('hide');html='<div class="alert alert-success alert-dismissable">'+rs.messages+'</div>';$("#alertModal").modal('show');$('#alertModal .modal-body').empty();$('#alertModal .modal-body').append(html);var htmlToAppend='<div class="item-block"><div class="item-icon"><i class="fa fa-tag text-info"></i></div><div class="item-infor "><span class="text text-info">'+rs.status+' <i style="cursor:pointer;" data-status="'+salesStage+'" data-leadid="'+leadId+'" class="fa fa-times text-danger removeOpportunityStatus"></i></span></div></div>';elementToAppend.empty().append(htmlToAppend);}else{$("#updateOpportunityModal").modal('hide');html='<div class="alert alert-warning alert-dismissable">'+rs.messages+'</div>';$("#alertModal").modal('show');$('#alertModal .modal-body').empty();$('#alertModal .modal-body').append(html);}});});$('#updateNhanhStore').on('click',function(){var accountId=$('#accountId').val();$('#updateNhanhStoreIdModal').modal('show');$.ajax({url:"/crm/customer/updateinformation?accountId="+accountId,dataType:'json',success:function(rs){if(!rs.code){$('#updateNhanhStoreIdModal').modal('hide');$('#errorModal .alert').html(rs.messages.join('<br/>'));$('#errorModal').modal('show');}else{$('#updateNhanhStoreIdModal .nhanhStoreId').val(rs.data.nhanhStoreId);$('#updateNhanhStoreIdModal .nhanhStoreName').val(rs.data.nhanhStoreName);$('#updateNhanhStoreIdModal .inputArea').show();$('#updateNhanhStoreIdModal .loadingArea').hide();}}});})
$('#updateNhanhStoreIdModal .save').click(function(){$(this).prop('disabled',true);$.post('/crm/customer/updateinformation',{accountId:$('#accountId').val(),nhanhStoreId:$('#updateNhanhStoreIdModal .nhanhStoreId').val(),nhanhStoreName:$('#updateNhanhStoreIdModal .nhanhStoreName').val(),itemType:'nhanhStoreId'},function(rs){$('#updateNhanhStoreIdModal .save').prop('disabled',false);if(rs.code==0){$('#updateNhanhStoreIdModal').modal('hide');$('#errorModal .alert').html(rs.messages.join('<br/>'));$('#errorModal').modal('show');}else{$('#alertModal .modal-body').empty().append('<div class="alert alert-success">Cập nhật thành công!</div>');$('#updateNhanhStoreIdModal').modal('hide');$('#alertModal').modal('show');}});});$('.editDescription').on('click',function(){var leadId=$(this).attr('data-leadid');var description=$(this).attr('data-description');$('#updateDescription #leadIdDescription').empty().val(leadId);$('#updateDescription #description-txt').empty().text(description);$('#updateDescription').modal('show');})
$('#updateDescription').on('click','.editDescriptionBtn',function(){var leadId=$('#updateDescription #leadIdDescription').val();var description=$('#updateDescription #description-txt').val();$.post('/crm/lead/edit?tab=description',{'leadId':leadId,'description':description,},function(rs){if(rs.code){$("#updateDescription").modal('hide');html='<div class="alert alert-success alert-dismissable">Cập nhật thành công</div>';$("#alertModal").modal('show');$('#alertModal .modal-body').empty();$('#alertModal .modal-body').append(html);}else{$("#updateDescription").modal('hide');html='<div class="alert alert-warning alert-dismissable">'+rs.messages+'</div>';$("#alertModal").modal('show');$('#alertModal .modal-body').empty();$('#alertModal .modal-body').append(html);}});})
$('.updateSource').on('click',function(){var leadId=$(this).attr('data-id');$('#updateSourceModal .confirmUpdateSource').attr('data-leadId',leadId);$('#updateSourceModal').modal('show');});$('#updateSourceModal .confirmUpdateSource').on('click',function(){var leadId=$(this).attr('data-leadId');if(!$('#leadSource').val()){$("#updateSourceModal").modal('hide');var html='<div class="alert alert-warning alert-dismissable">Bạn chưa chọn nguồn khách hàng</div>';$("#alertModal").modal('show');$('#alertModal .modal-body').empty();$('#alertModal .modal-body').append(html);return false;}
$.post('/crm/lead/updatesource',{'leadId':leadId,'source':$('#leadSource').val(),},function(rs){if(rs.code){$("#updateSourceModal").modal('hide');var html='<div class="alert alert-success alert-dismissable">'+rs.messages+'</div>';$("#alertModal").modal('show');$('#alertModal .modal-body').empty();$('#alertModal .modal-body').append(html);}else{$("#updateSourceModal").modal('hide');html='<div class="alert alert-warning alert-dismissable">'+rs.messages+'</div>';$("#alertModal").modal('show');$('#alertModal .modal-body').empty();$('#alertModal .modal-body').append(html);}});})})
function appendNameSuggest(item,element){var tag=$('<span/>').addClass('tag label label-info').attr('data-userid',item.id);tag.append(item.fullName);tag.append($('<span/>').addClass('removeTag').attr('data-role','remove'));element.find('input[type="text"]').before(tag);}