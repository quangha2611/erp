var isSubmit=false;$(function(){Industry.load('#companyId','#industrySelect','');Address.load('#cityId','#districtId');$('#districtId').select2();$('#cityId').select2();$('#industrySelect').select2();$('#requestPhonecall').on('change',function(){if($(this).is(':checked')){$('#requestTimeCall, #requestUserIds').closest('.form-group').show();}else{$('#requestTimeCall, #requestUserIds').closest('.form-group').hide();}});if($('#requestPhonecall').is(':checked')){$('#requestTimeCall, #requestUserIds').closest('.form-group').show();}else{$('#requestTimeCall, #requestUserIds').closest('.form-group').hide();}
$('#calendar_user_input').click(function(){$('#tag-input').focus();});$('#birthdate').each(function(){var option={format:'DD/MM/YYYY',minDate:'01/01/1950',startDate:'01/01/1950',endDate:moment().subtract(18,'years'),maxDate:moment().subtract(18,'years'),showDropdowns:true,timePicker:false,timePickerIncrement:15,opens:'left',singleDatePicker:true};$(this).daterangepicker(option)});$('#tag-input').autocomplete({source:function(request,response){$.post('/system/user/suggest',{'q':request.term,},function(rs){if(rs.code){response(rs.data);}else{response([]);}});},minLength:2,select:function(event,ui){event.preventDefault()
addUser(ui.item)},close:function(){$('#tag-input').val('');}});$('#calendar_user_input').on('click','span[data-role="remove"]',function(){$(this).parent().remove();var userIds=[];$('#calendar_user_input span.tag').each(function(){userIds.push($(this).attr('idref'));});$('#requestUserIds').val(userIds.join(','));});$('#btnSaveCrmLead').click(function(){var emailArr=[];var websiteArr=[];var phoneArr=[];var industriesArr=[];var addressArr=[];$('.email').each(function(){if($(this).val()){emailArr.push($(this).val());}});$('.website').each(function(){if($(this).val()){websiteArr.push($(this).val());}});$('.phone').each(function(){if($(this).val()){phoneArr.push($(this).val());}});$('.address').each(function(){if($(this).val()){addressArr.push($(this).val());}});if(emailArr){$('#emails').val(JSON.stringify(emailArr));}
if(websiteArr){$('#websites').val(JSON.stringify(websiteArr));}
if(addressArr){$('#addresses').val(JSON.stringify(addressArr));}
if(phoneArr){$('#phones').val(JSON.stringify(phoneArr));}
$('#industry-items .industry-item').each(function(){industriesArr.push($(this).attr('data-id'))})
$('#industries').val(industriesArr.join('-'));if(!isSubmit){addOverLay();isSubmit=true;$('#crmLead').submit();}})
$('.addAddress').on('click',function(){var input='<input type="text" class="address form-control"  />';$('.address-content').append(input);})
$('.addWebsite').on('click',function(){var input='<input type="text" class="website form-control"  />';$('.website-content').append(input);})
$('.addEmail').on('click',function(){var input='<div class="input-group">';input+='<span class="input-group-addon"><i class="fa fa-envelope-o"></i></span>';input+='<input type="text"  maxlength="255"  class="email form-control" value="">';input+='</div>';$('.email-content').append(input);})
$('.addPhone').on('click',function(){var input='<div class="input-group">';input+='<span class="input-group-addon"><i class="fa fa-phone"></i></span>';input+='<input type="text"  maxlength="255"  class="phone form-control" value="">';input+='</div>';$('.phone-content').append(input);})
$('#crmLead').on('change','.phone',function(){var input_group=$(this).parent();var col_md=$(this).closest('.col-md-8');var item=$(this);col_md.find('ul.parsley-error-list').remove();input_group.removeClass('has-error has-success');col_md.find('.input-group-addon').html('<i class="fa fa-rotate-right fa-spin"></i>');if($(this).val()){$.post('/crm/lead/checkinfor',{'q':item.val(),'type':'mobile'},function(rs){if(rs.code){col_md.find('ul.parsley-error-list').remove();input_group.addClass('has-success').removeClass('has-error');col_md.find('.input-group-addon').html('<i class="fa fa-check text-success"></i>');}else{var ul=$('<ul/>').addClass('parsley-error-list');ul.append($('<li/>').html(rs.messages));col_md.append(ul);input_group.removeClass('has-success').addClass('has-error');col_md.find('.input-group-addon').html('<i class="fa fa-times text-danger"></i>');}});}else{col_md.find('.input-group-addon').html('<i class="fa fa-phone"></i>');}});$('#crmLead').on('change','.email',function(){var input_group=$(this).parent();var col_md=$(this).closest('.col-md-8');var item=$(this);col_md.find('ul.parsley-error-list').remove();input_group.removeClass('has-error has-success');col_md.find('.input-group-addon').html('<i class="fa fa-rotate-right fa-spin"></i>');if($(this).val()){$.post('/crm/lead/checkinfor',{'q':item.val(),'type':'email'},function(rs){if(rs.code){col_md.find('ul.parsley-error-list').remove();input_group.addClass('has-success').removeClass('has-error');col_md.find('.input-group-addon').html('<i class="fa fa-check text-success"></i>');}else{var ul=$('<ul/>').addClass('parsley-error-list');ul.append($('<li/>').html(rs.messages));col_md.append(ul);input_group.removeClass('has-success').addClass('has-error');col_md.find('.input-group-addon').html('<i class="fa fa-times text-danger"></i>');}});}else{col_md.find('.input-group-addon').html('<i class="fa fa-envelope-o"></i>');}});$('#crmLead').on('change','.website',function(){var input_group=$(this).parent();var col_md=$(this).closest('.col-md-8');var item=$(this);col_md.find('ul.parsley-error-list').remove();input_group.removeClass('has-error has-success');col_md.find('.input-group-addon').html('<i class="fa fa-rotate-right fa-spin"></i>');if($(this).val()){$.post('/crm/lead/checkinfor',{'q':item.val(),'type':'website'},function(rs){if(rs.code){col_md.find('ul.parsley-error-list').remove();input_group.addClass('has-success').removeClass('has-error');col_md.find('.input-group-addon').html('<i class="fa fa-check text-success"></i>');}else{var ul=$('<ul/>').addClass('parsley-error-list');ul.append($('<li/>').html(rs.messages));col_md.append(ul);input_group.removeClass('has-success').addClass('has-error');col_md.find('.input-group-addon').html('<i class="fa fa-times text-danger"></i>');}});}else{col_md.find('.input-group-addon').html('<i class="fa fa-envelope-o"></i>');}});$('#crmLead').on('click','.care-leadId',function(){var userId=$(this).attr('data-userId');var id=$(this).attr('data-leadId');console.log(userId);var saleIds=[];saleIds.push(userId);console.log(saleIds);$.post('/crm/lead/setleaduser',{'id':id,'crm_type':'lead','mode':'selfAssign','saleIds':saleIds.join(','),},function(rs){if(rs.code){html="<div class='alert alert-success'>Nhận chăm sóc thành công! </div>";$('#alertModal').modal('show');$('#alertModal .modal-body').empty();$('#alertModal .modal-body').append(html);}else{html="<div class='alert alert-warning'>"+rs.messages+" </div>";$('#alertModal').modal('show');$('#alertModal .modal-body').empty();$('#alertModal .modal-body').append(html);}});});$('#crmLead').on('click','.care-account',function(){var userId=$(this).attr('data-userId');var id=$(this).attr('data-leadId');console.log(userId);var saleIds=[];saleIds.push(userId);console.log(saleIds);$.post('/crm/lead/setleaduser',{'id':id,'crm_type':'lead','mode':'selfAssign','saleIds':saleIds.join(','),},function(rs){if(rs.code){html="<div class='alert alert-success'>Nhận chăm sóc thành công! </div>";$('#alertModal').modal('show');$('#alertModal .modal-body').empty();$('#alertModal .modal-body').append(html);}else{html="<div class='alert alert-warning'>"+rs.messages+" </div>";$('#alertModal').modal('show');$('#alertModal .modal-body').empty();$('#alertModal .modal-body').append(html);}});});$('#industrySelect').on('change',function(){if(!$(this).val()){return;}
var id=$(this).val();var name=$(this).find('option[value="'+id+'"]').text();addIndustry(id,name);});$('#industry-items').on('click','.removeItem',function(){$(this).closest('span').remove();})});function addUser(item){if(!$('#calendar_user_input').find('span[idref="'+item.id+'"]').length){var tag=$('<span/>').addClass('tag label label-info').attr('idref',item.id).text(item.username).append($('<span>').attr('data-role','remove'));$('#tag-input').before(tag);var userIds=[];$('#calendar_user_input span.tag').each(function(){userIds.push($(this).attr('idref'));});$('#requestUserIds').val(userIds.join(','));}
$('#tag-input').autocomplete('close');$('#tag-input').val('');}
function addIndustry(id,name){if(!id||!name){return;}
if($('#industry-items .industry-item[data-id="'+id+'"]').length){return false;}
var html='<span data-id="'+id+'" class="label label-default industry-item"> '+name+' <i class="fa fa-times removeItem text-danger"></i></span>';$('#industry-items').append(html);}