$(function(){ActivityListController.init();});var ActivityListController={'errorModal':'<div class="modal fade" tabindex="-1" role="dialog" id="errorModal"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title">Lỗi</h4></div><div class="modal-body"><div class="alert alert-danger"></div></div><div class="modal-footer"><button type="button" class="btn btn-default" data-dismiss="modal">Đóng</button></div></div></div></div>','messages':{'SERVER_ERROR':'Lỗi trong quá trình thực hiện',},'addCommentTemplate':'<ul class="list-unstyled addComment-list activity-sub-list "><li><a class="fa fa-floppy-o activity-icon activity-icon-o pull-left save-comment"></a><textarea class="form-control addComment-content" rows="1"></textarea></li></ul>','commentTemplate':'<li>'+'<p><span class="text-primary">{{CREATED_BY_NAME}}</span> <span class=" text-muted">- {{SHORT_DESCRIPTION}}</span></p>'+'<p>{{CONTENT}}</p>'+'<p class="uiActivityAction">'+'<span class="fontsize-85 text-muted">{{CREATED_DATE_TIME}}</span>'+'</p>'+'</li>','init':function(){if(!$('#errorModal').length){$('body').append(this.errorModal);}
$('#activity-section').on('click','.addComment',function(){var li=$(this).closest('li');if(!li.find('ul.addComment-list').length){li.append(ActivityListController.addCommentTemplate);li.find('.addComment-list .addComment-content').focus();}});$('#activity-section').on('click','.save-comment',function(e){var addCommentList=$(this).closest('ul.addComment-list');var li=$(this).closest('li.activity-list-item');if(!addCommentList.hasClass('content-saving')){addCommentList.addClass('content-saving');var param={relatedId:li.data('id'),content:addCommentList.find('.addComment-content').val()};addCommentList.find('.save-comment').prop('disabled',true);addCommentList.find('.addComment-content').prop('disabled',true);$.post('/crm/activity/addcomment',param,function(rs){if(typeof rs.code!='undefined'){if(rs.code){var comment=ActivityListController.commentTemplate;comment=comment.replace('{{CREATED_BY_NAME}}',rs.data.createdByName);comment=comment.replace('{{SHORT_DESCRIPTION}}',rs.data.shortDescription);comment=comment.replace('{{CONTENT}}',rs.data.content);comment=comment.replace('{{CREATED_DATE_TIME}}',rs.data.createdDateTime);if(li.find('.related-list').length){console.log('aaa');li.find('.related-list').append(comment);}else{console.log('bbb');addCommentList.before('<ul class="list-unstyled related-list activity-sub-list">'+comment+'</ul>');}
addCommentList.remove();}else{$('#errorModal .alert').html(rs.messages.join('<br/>'));$('#errorModal').modal('show');addCommentList.find('.save-comment').prop('disabled',false);addCommentList.find('.addComment-content').prop('disabled',false);addCommentList.removeClass('content-saving');}}else{$('#errorModal .alert').html(ActivityListController.messages.SERVER_ERROR);$('#errorModal').modal('show');addCommentList.find('.save-comment').prop('disabled',false);addCommentList.find('.addComment-content').prop('disabled',false);addCommentList.removeClass('content-saving');}}).fail(function(){$('#errorModal .alert').html(ActivityListController.messages.SERVER_ERROR);$('#errorModal').modal('show');addCommentList.find('.save-comment').prop('disabled',false);addCommentList.find('.addComment-content').prop('disabled',false);addCommentList.removeClass('content-saving');});}});$('#activity-section .viewDetail').on('click',function(){$(this).closest('li').find('.well').toggle();});},};