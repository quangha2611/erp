$(function(){Department.load('#companyId','#departmentId');$('.exportExcel').jsExcelExport({'param':{'format':'excel'}});$('#exportAll').jsExcelExport({'param':{'format':'csv'}});$('#employeeName').autocomplete({source:function(request,response){$.post('/hrm/employee/suggest',{'q':request.term,},function(rs){if(rs.code){response(rs.data);}});},minLength:2,select:function(event,ui){$('#employeeId').val(ui.item.id);},});$('.deleteTarget').on('click',function(){var item=$(this);$.post("/crm/target/delete",{'id':$(this).attr('data-id'),},function(rs){if(rs.code){item.closest('td').closest('tr').remove();}else{var html='<div class="alert alert-warning alert-dismissable"> '+rs.messages+'</div>';$("#myModal").modal('hide');$("#alertModal").modal('show');$('#alertModal .modal-body').empty();$('#alertModal .modal-body').append(html);}});});$('#cbCheckAll').on('change',function(){if($(this).is(':checked')){$('.check-target').prop('checked',true);}else{$('.check-target').prop('checked',false);}});$('#approved-confirm').on('click',function(){var ids=[];var flag=false;$('.check-target:checked').each(function(){var id=$(this).attr('data-id');if(id){ids.push(id);flag=true;}});if(!flag){var html="<div class='alert alert-warning'>Bạn chưa chọn chỉ tiêu!</div>";$('#alertModal').modal('show');$('#alertModal .modal-body').empty();$('#alertModal .modal-body').append(html);}else{$('#myApproveModal').modal('show');var idStr=JSON.stringify(ids);var html="<div class='alert alert-info'>Bạn có muốn duyệt những chỉ tiêu này?</div>";html+='<input type="hidden" id="ids" value="'+idStr+'" />';$('#myApproveModal .modal-body').empty();$('#myApproveModal .modal-body').append(html);}});$('#confirm-approve').on('click',function(){var ids=[];$('.check-target:checked').each(function(){var id=$(this).attr('data-id');ids.push(id);});$('#myApproveModal').modal('hide');approveAutomation.start(ids);});});var approveAutomation={ids:[],index:0,start:function(ids){if(!ids||!ids.length){return this.errorHandler('Bạn chưa chọn các chỉ tiêu để duyệt');}
this.ids=ids;$('#approvingModal').modal('show');$('#approvingModal .approving-text').text('');this.index=0;this.process();},process:function(){if(typeof this.ids[this.index]=='undefined'){return this.end();}
var id=this.ids[this.index];var textProcess=this.index+' / '+this.ids.length;this.index+=1;$.post("/crm/target/approvemulti",{'ids':JSON.stringify([id]),},function(rs){if(typeof rs.code!='undefined'){if(rs.code){$('#approvingModal .approving-text').text(textProcess);return approveAutomation.process();}else{return approveAutomation.errorHandler(rs.messages.join('<br/>'));}}else{return approveAutomation.errorHandler('Lỗi trong quá trình thực hiện');}}).fail(function(){return approveAutomation.errorHandler('Lỗi trong quá trình thực hiện');});},end:function(){window.location.reload();},errorHandler:function(messages){$('#approvingModal').modal('hide');$('#errorModal .alert').html(messages);$('#errorModal').modal('show');}}